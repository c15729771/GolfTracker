{% extends 'Golf_Journal/base.html' %}
{% block head %}
            <div class="tracking">
        <h1>Track Your Game</h1>
    </div>

    <div id="map">

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
              integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
              crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
                    integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
                    crossorigin="">

        </script>

    </div>
    <div id="startTrackingDiv" class="trackNow">
        <button class="btn" onclick="startGeoLocationTracking()">Start Tracking</button>
    </div>
    <div id="stopTrackingDiv" class="trackNow">
        <button class="btn btn-destructive" onclick="stopGeoLocationTracking()">Stop Tracking</button>
    </div>

    <footer>
        <p>GolfJournal, Copyright &copy; 2019</p>
    </footer>

    <script>

    var geo = navigator.geolocation;
    var mapLineCoordinates = [];//Holds coordinates for moving user, stored as geocode pairs i.e. [[123,123],[124,124]]
    var map; //Class level reference to map object
    var watchId; //The Id of the Geolocation watcher, needed to turn off watching(i.e. tracking)
    window.onload = function(){
        getCurrentLocation();
        showStartTrackingButton();
    }

    /*
        @Description    Attempts to get Users current GeoLocation codes
    */
    function getCurrentLocation(){
        //document.getElementById('startTrackingDiv').style.display = 'none';
        if(geo){
            geo.getCurrentPosition(initMapWithCurrentLocation, geoInfoErrorCallback, {timeout:10000, enableHighAccuracy:true});
        }
    }

    /*
        @Description    Begins tracking a users GeoLocation for movement
    */
    function startGeoLocationTracking(){
        console.log('Tracking started!');
        //The success callback method is called whenever a users position is updated
        watchId = geo.watchPosition(setCurrentLocationOnMap, geoInfoErrorCallback, {timeout:10000, enableHighAccuracy:true});
        showStopTrackingButton();
    }

    /*
        @Description    Stops tracking users location
    */
    function stopGeoLocationTracking(){
        console.log('Tracking stopped!');
        geo.clearWatch(watchId);
        showStartTrackingButton();
        var lastEnteredCoOrds = mapLineCoordinates[mapLineCoordinates.length-1];
        createMapMarker(map, 'End', lastEnteredCoOrds[0], lastEnteredCoOrds[1], false);
    }

    /*
        @Description    Parses a Geolocation position object and prints the result to the console
    */
    function initMapWithCurrentLocation(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;
        var div = document.getElementById( 'location' );
        initMap(longitude, latitude);
    }

    /*
        @Description    Sets the current location on the Map when a user first open the TrackNow functionality
    */
    function setCurrentLocationOnMap(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;
        drawLineOnMap(map, longitude, latitude);
    }

    /*
        @Description    Used to process an error response from a Geolocation callout
    */
    function geoInfoErrorCallback(){
        console.log('Geo Info not available!');
    }

    /*
        @Description    Initializes the map with the location passed in as parameters
    */
    function initMap(longitude, latitude){
        // initialize the map
        map = L.map('map').setView([latitude, longitude], 14.8);

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
            maxZoom: 18,
            id: 'mapbox.streets',
            accessToken: 'pk.eyJ1IjoiYzE1NzI5NzcxIiwiYSI6ImNqb2hkZ3I4MzBpYTEzcG8zdG9menE4aWgifQ.omQRZRZ0uMdYT7Dc-qVXwQ'
        }).addTo(map);

        createMapMarker(map, "Hole 1 Tee off", latitude, longitude, true);
        drawLineOnMap(map, longitude, latitude);
    }

    /*
        @Description     Creates a marker on the map
        @param           startMarker - set to true for a start marker, false for an end
    */
    function createMapMarker(map, markerMessage, latitude, longitude, startMarker) {
        var marker;
        if(startMarker){
            marker = marker = setCustomGpsMarker(map, latitude, longitude, 'green_gps_marker.png');

        }
        else{
            marker = setCustomGpsMarker(map, latitude, longitude, 'red_gps_marker.png');
        }
        marker.bindPopup(markerMessage);
        marker.on('click', showMarkerBaloon);
    }

    /*
        @Description    Shows baloon above marker
    */
    function showMarkerBaloon(e) {
        var popup = e.target.getPopup();
        var content = popup.getContent();
    }

    /*
        @Description    draws a line on the map based on the geocode values stored in mapLineCoordinates
        @param          longitude - the longitude value to add to mapLineCoordinates
        @param          latitude - the latitude value to add to mapLineCoordinates
    */
    function drawLineOnMap(map, longitude, latitude) {
        var coordinatePair = [latitude, longitude];
        mapLineCoordinates.push(coordinatePair);

        var polyline = L.polyline(mapLineCoordinates,
            {
                color: 'blue',
                weight: 3,
                opacity: 5,
                dashArray: '10,5',
                lineJoin: 'round'
            }
        ).addTo(map);
    }

    /*
        @Description    Hides the stop tracking button and shows the start tracking button
    */
    function showStartTrackingButton(){
        $("#startTrackingDiv").show();
        $("#stopTrackingDiv").hide();
    }

    /*
        @Description    Hides the start tracking button and shows the stop tracking button
    */
    function showStopTrackingButton(){
        $("#startTrackingDiv").hide();
        $("#stopTrackingDiv").show();
    }

    /*
        @Description    Adds a red marker to the map
    */
    function setCustomGpsMarker(map, latitude, longitude, imageName){
        /*var myIcon = L.icon({
            iconSize: [28, 42],
            iconAnchor: [13,42],
            popupAnchor: [-3, -42],
            iconUrl: '../static/images/icons/'+imageName
        });
        var marker = L.marker([latitude, longitude], {icon: myIcon}).addTo(map);
        return marker;*/
        var marker = L.marker([latitude, longitude]).addTo(map);
        return marker;
    }

    </script>
{% endblock %}
{% block content %}

{% endblock content %}
